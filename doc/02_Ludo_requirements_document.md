# ルドー 実装仕様書

## ドキュメント管理

### 変更履歴
| バージョン | 日付 | 変更内容 |
|:---:|:---|:---|
| v1.0 | 2025/11/22 | 初版作成（オセロ仕様を参考に作成） |
| v2.0 | 2025/11/22 | 完全実装（2〜4人対応、CPU選択、ルール設定、ログ機能） |
| v2.1 | 2025/11/22 | UI/UX改善（アラート追加、グラフィカル化、CPU思考時間） |
| v2.2 | 2025/11/23 | ルール明確化（パス40マス化、セーフマス削除、ターン表示） |

### 文書の目的
本仕様書は、Webポータル「GAME PORTAL」に実装する「ルドー（Ludo）」ゲームの要件を定義する。2～4人対応のボードゲームとして、ローカル対戦・CPU対戦・将来的なオンライン拡張を視野に入れた設計とする。

## 1. プロジェクト概要

### 1.1 ゲームコンセプト
- **ジャンル**: すごろく型ボードゲーム
- **目的**: サイコロを振って4つのコマを全てゴールさせる
- **特徴**:
  - 2〜4人対応
  - サイコロによる運要素と戦略性
  - 捕獲システムによる駆け引き
  - 3段階のCPU難易度

### 1.2 技術要件
- **使用言語**: HTML5, CSS3, JavaScript (ES6+)
- **フレームワーク**: なし（Vanilla JS）
- **ブラウザ要件**: モダンブラウザ（Chrome, Firefox, Safari, Edge 最新版）
- **レスポンシブ対応**: PC・タブレット・スマートフォン

## 2. ゲーム仕様


## 基本要件
- ブラウザで動作するルドーゲームを作成する（2〜4 人、プレイヤー数は開始時に選択）
- 使用技術：HTML、CSS、JavaScript
- トークンは各プレイヤー 4 個
- スタート・ホーム・ゴールのルールに従う
- サイコロ（1〜6 の数字）を振って進行
    - 6 が出たら追加ターン
    - サイコロで 6 が出ないとベース（出発エリア）からトークンを出せない（設定で変更可）
- 他プレイヤーのトークンと同じマスに止まるとそのトークンはスタートに戻る（捕獲）
- ゴール（ホーム）へ入るために「正確な目」が必要（設定でオプション可）
- ターン制（時計回り）。ターン終了後、次プレイヤーへ移る（6 の追加ターンを除く）
- ローカル対人（ホットシート）に対応
- CPU 対戦（AI）を 3 段階の難易度で選択できる
    - レベル1：ランダムに合法な手を選ぶ
    - レベル2：キャプチャを優先 / 最大進行距離を選ぶ（貪欲）
    - レベル3：簡易評価関数（安全度、ゴール進行度、キャプチャの期待値）による選択
- オンライン対戦・フレンド対戦の拡張性を持たせる（ソケットや WebRTC 経由の接続を想定した設計）


## ルール（デフォルト実装）
- プレイヤーは順番にサイコロを振る
- サイコロで 6 を出すとベースからトークンをスタートマスに出せる（未実装の場合は設定で ON/OFF）
    - ただし、スタート位置に既に自分のトークンがいる場合は、新しいトークンを出すことはできない
    - その場合は、既にボード上にあるトークンを6マス進める必要がある
- 既に出ているトークンはサイコロの目に応じてボード上を進む
- 他プレイヤーのトークンがいる通常マスに止まるとそのトークンをベースに戻す（捕獲）
- セーフマスでは捕獲されない（マスは配置と数を設計で可変に）
    - 現在の実装では、セーフマスは存在せず、全てのマスで捕獲が可能
- 自身の最終ホーム列（各色のゴールに続く狭路）に入るにはボード上の進行ルートに従う。ゴールに入るには正確なサイコロ目を要求（設定可能）
- 同一マスに自分のトークンが2個以上いる場合はブロック（相手はそのマスに止まれない）とするか、許可するかは設定で選べる（ルールバリエーション対応）
    - 現在の実装では、同じマスに複数のトークンを置くことはできない（自分のトークンも含む）
- 1 人のプレイヤーの全トークンがゴールに到達したら勝利（上位表示：到達順で順位決定）


## UI 要件
- 典型的なルドーボードを 2D 表示（盤は SVG か CSS グリッドで実装）
- 各色（赤・青・黄・緑）のスタートエリア、ホームエリア、走路を視覚的に区別
- トークンは CSS で丸またはアイコンで描画。トークン上に数字（識別番号）を表示できると親切
- サイコロ表示（ボタン＋アニメーション）とサイコロの目を視覚表示
- 現在の手番表示（例：「赤の番：サイコロを振ってください」）とターン履歴（簡易ログ）
- 使用可能な手（動かせるトークン）をハイライトして、ユーザーが選択できるようにする
- リセット（新しいゲーム開始）ボタン、設定（プレイヤー数／AIレベル／ルールバリエーション）パネル
- スマホでも操作できるレスポンシブデザイン（タップ操作、拡大縮小対応）
- アニメーション（トークンの移動、捕獲時のエフェクト）はオプションで有効／無効にできる
- アクセシビリティ：キーボード操作サポート、コントラスト、ARIA ラベル。


## ロジック要件
### サイコロ処理
- rollDice() を実装し、1〜6 の乱数を返す。アニメーション付きで表示
- 6 の追加ターンロジック（設定で ON/OFF）。

### 手の候補計算
- getLegalMoves(player, diceValue)：現在のプレイヤーとサイコロ目から合法手（動かせるトークンと移動先）を列挙する
    - ベースから出す（6 のとき）候補
    - 既出トークンの移動候補（ボード上の走路とホーム列に対する検査）
    - ブロックやセーフマスルールを考慮。

### トークン移動と捕獲
- moveToken(player, tokenId, steps)：トークンを steps だけ移動させる（アニメーションオプションあり）
- 到達後、移動先に他プレイヤーのトークンがあるか判定し、捕獲処理を行う（captureToken(victimPlayer, victimTokenId)）
- トークンがゴールに入る判定（全トークンがホームに入っているかを更新）

### ブロック（オプション）
- 同一プレイヤーのトークンが複数いるマスをブロックにする場合、isBlocked(position, byPlayer) で判定し動けるかを判断

### セーフマス
- セーフマス判定（捕獲無効）
- ボード設計時に安全マスの配列を定義

### 勝敗・順位判定
- ゲームが終了したら（全プレイヤーが動けなくなった or あるプレイヤーが全トークンをゴールさせた）順位を算出する
- 途中脱落や引き分けの取り扱いを定義（通常は順位で表示）

## CPU要件
getAIMove(player, diceValue, level) を実装。level は 1〜3
- レベル1（ランダム）：legalMoves からランダム選択
- レベル2（貪欲）：キャプチャ可能な手を最優先、次にゴールへ近づく手（最大進行距離）を選択
- レベル3（評価関数）：以下の簡易評価関数で各候補手を評価して最大スコアを選択。
    - 評価項目例：
        - キャプチャの有無（大きいプラス）
        - 自分のトークンがセーフマスに入る（中プラス）
        - トークンがゴールに近づく距離（小プラス）
        - 相手に捕獲されるリスク（マイナス）
- 実装はまずは単手読み。後で2手先探索（ミニマックス深さ 2）に拡張できる設計にする。


## UI/UX デバッグ要件（任意）
- console.log でターンごとの状態変化（サイコロ目、選択トークン、移動先、捕獲）を出力できるモードを用意
- dumpBoardState() で内部データ（各トークンの位置、各プレイヤーのゴール到達数）を出力
- 各主要関数に処理説明コメント、引数・戻り値の注釈を追加する


## 設定（オプションパラメータ）
- プレイヤー数（2〜4）
- 各プレイヤーのタイプ（ヒト／AI、AI レベル）
- 6 の追加ターンルール（ON/OFF）
- ベースから出る条件（6 必須／任意）
- ゴールに入るときの正確目ルール（必要／不要）
- ブロック有無（同色トークン2個でブロック）
- セーフマスの位置（デフォルト配置とカスタム配置）
- アニメーションの有効／無効
- サウンドの有効／無効


## テストケース（開発時に確認すること）
1. サイコロで 6 を出してベースからトークンが出る挙動（ON/OFF 設定の確認）
2. トークン移動と捕獲処理（他プレイヤーのトークンをスタートに戻す）
3. セーフマスで捕獲されないことの確認
4. ブロックルールの挙動（移動可能／不可）
5. ゴール（ホーム）への正確な到達判定（正確目ルール）
6. AI レベルごとの手の選択（ランダム／貪欲／評価関数）
7. 6 の追加ターンが継続することの確認（無限ループ対策）
8. モバイルでのタップ操作と UI の崩れがないこと
9. 複数ゲーム連続プレイでの状態リセットが正常に動作すること


## コード品質要件
- 可読性優先の変数名・関数名（例：player, tokenId, positionIndex, rollDice()）
- グローバル変数は必要最小限に（状態は GameState オブジェクトで管理）
- 主要処理に JSDoc または簡潔なコメントを付与（引数・戻り値を明記）
- マジックナンバーを避け、定数（例：BOARD_SIZE, TOKENS_PER_PLAYER, SAFE_POSITIONS）を定義
- ロジック（合法手列挙・移動・捕獲・勝敗判定・AI）は関数単位で分離し再利用可能にする
- 単体テスト（可能であれば）で getLegalMoves() や moveToken() の動作を検証できるように設計する


## 拡張案（将来的な機能）
- オンライン対戦（マッチメイキング / フレンド招待）用 API 層とソケット通信設計
- 観戦モード、リアルタイムチャット、ターンタイムアウト
- ローカルデータ保存（ローカルストレージ）で対戦成績を記録
- カスタムボード（セーフマスや走路をカスタマイズ可能）
- 2D → 3D 表示切り替え（WebGL / Three.js など）
- 詳細な AI（モンテカルロ・ツリー探索や深層学習ベース）への拡張


## 配布・納品要件
- 最低限の完成物（ローカル対人・AI レベル1〜3 対応）をまず実装し、README に遊び方・設定手順を記載すること
- 変更時は必ずこの仕様書の「変更履歴」を更新すること